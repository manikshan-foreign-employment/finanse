<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartDocs SL - Business Finance Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #4f46e5;
            --primary-dark: #1e1b4b;
            --emerald: #10b981;
            --rose: #f43f5e;
            --amber: #f59e0b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border-color: #f1f5f9;
        }

        .dark-mode {
            --bg-body: #020617;
            --bg-card: #0f172a;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border-color: #1e293b;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .premium-gradient { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
        .bg-custom-card { background: var(--bg-card); border: 1px solid var(--border-color); }
        .bottom-nav { background: var(--bg-card); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); height: 85px; }
        
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 25%; color: var(--text-sub); }
        .active-nav { color: var(--primary); }

        .btn-touch { transition: transform 0.1s; cursor: pointer; }
        .btn-touch:active { transform: scale(0.96); }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75); 
            backdrop-filter: blur(10px); z-index: 1000; 
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-sheet {
            background: var(--bg-card); width: 100%; max-width: 500px;
            border-radius: 2.5rem 2.5rem 0 0; padding: 2rem; max-height: 90vh;
            overflow-y: auto; transform: translateY(0); transition: 0.3s;
        }

        input, select {
            background: rgba(0,0,0,0.03); border: 1px solid var(--border-color);
            border-radius: 1rem; padding: 1rem; width: 100%; outline: none; font-weight: 600; color: var(--text-main);
        }
        .dark-mode input, .dark-mode select { background: rgba(255,255,255,0.05); }

        .tab-btn { flex: 1; padding: 1rem; border-radius: 0.75rem; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        .balance-glow { box-shadow: 0 20px 25px -5px rgba(79, 70, 229, 0.2); }
    </style>
    
    <script>
        // Page එක Load වීමටත් පෙරම කලින් save කළ theme එක apply කරනවා (Flashing වැලැක්වීමට)
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>
</head>
<body class="pb-32">

    <script>
        // Body එකට class එක ඇතුලත් කිරීම
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    </script>

    <header class="premium-gradient text-white px-8 pt-16 pb-32 rounded-b-[3.5rem] shadow-xl relative">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black tracking-tighter uppercase italic">SmartDocs SL</h1>
                <p class="text-indigo-200 text-[10px] font-bold uppercase tracking-[0.3em] mt-1">Finance Command Center</p>
            </div>
            <button onclick="toggleTheme()" class="w-11 h-11 bg-white/10 rounded-2xl flex items-center justify-center btn-touch backdrop-blur-md">
                <i id="theme-icon" class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-6 -mt-20">
        
        <div class="bg-custom-card p-8 mb-6 rounded-[2.5rem] text-center shadow-2xl border-none balance-glow relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-wallet text-6xl"></i></div>
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">Net Cash Balance</p>
            <h2 id="summary-cash" class="text-4xl font-black text-indigo-600 tracking-tighter italic mb-6">Rs. 0.00</h2>
            
            <div class="grid grid-cols-3 gap-2 border-t border-slate-100 dark:border-slate-800 pt-6">
                <div onclick="openSummary('income')" class="btn-touch">
                    <p class="text-[8px] font-black text-emerald-500 uppercase mb-1">Revenue</p>
                    <p id="total-income-view" class="text-xs font-extrabold text-slate-700 dark:text-slate-200">Rs. 0</p>
                </div>
                <div onclick="openSummary('expense')" class="btn-touch border-x border-slate-100 dark:border-slate-800">
                    <p class="text-[8px] font-black text-rose-500 uppercase mb-1">Expenses</p>
                    <p id="total-expense-view" class="text-xs font-extrabold text-slate-700 dark:text-slate-200">Rs. 0</p>
                </div>
                <div onclick="openSummary('savings')" class="btn-touch">
                    <p class="text-[8px] font-black text-amber-500 uppercase mb-1">Savings</p>
                    <p id="total-savings-view" class="text-xs font-extrabold text-slate-700 dark:text-slate-200">Rs. 0</p>
                </div>
            </div>
        </div>

        <div class="mb-8 bg-custom-card p-2 rounded-[1.8rem] shadow-sm">
            <div class="grid grid-cols-2 gap-2">
                <div class="flex items-center bg-slate-50 dark:bg-slate-900/50 rounded-2xl px-3">
                    <i class="fas fa-calendar-alt text-slate-400 text-xs"></i>
                    <input type="month" id="monthFilter" onchange="updateUI()" class="bg-transparent border-none text-[10px] py-3 font-bold uppercase">
                </div>
                <div class="flex items-center bg-slate-50 dark:bg-slate-900/50 rounded-2xl px-3">
                    <i class="fas fa-tag text-slate-400 text-xs"></i>
                    <select id="categoryFilter" onchange="updateUI()" class="bg-transparent border-none text-[10px] py-3 font-bold uppercase">
                        <option value="All">All Services</option>
                        <option value="Assignment Work">Assignment</option>
                        <option value="CV Document Design">CV Design</option>
                        <option value="System Development">System Dev</option>
                        <option value="Letter Writing">Writing</option>
                        <option value="Expenses">Expenses</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center px-2 mb-4">
            <h3 class="font-black text-indigo-900 dark:text-indigo-400 text-sm uppercase tracking-widest">Recent Transactions</h3>
            <button onclick="resetFilters()" class="text-[9px] font-bold text-slate-400 uppercase">Clear All</button>
        </div>

        <div id="ledger-list" class="space-y-3 mb-20"></div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bottom-nav flex items-center justify-around z-50 rounded-t-[3rem] shadow-2xl">
        <button class="nav-btn active-nav btn-touch"><i class="fas fa-th-large text-xl mb-1"></i><span class="text-[9px] font-black uppercase">Dashboard</span></button>
        <div class="relative w-16 h-16"><button onclick="openForm()" class="absolute -top-10 left-0 w-16 h-16 bg-indigo-600 text-white rounded-2xl flex items-center justify-center border-[6px] border-white dark:border-slate-900 shadow-xl btn-touch"><i class="fas fa-plus text-2xl"></i></button></div>
        <button onclick="openReports()" class="nav-btn btn-touch"><i class="fas fa-chart-line text-xl mb-1"></i><span class="text-[9px] font-black uppercase">Analytics</span></button>
    </nav>

    <div id="formModal" class="modal-overlay hidden" onclick="closeForm()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-800 rounded-full mx-auto mb-8"></div>
            <div class="flex bg-slate-100 dark:bg-slate-900 p-1.5 rounded-2xl mb-6">
                <button onclick="switchTab('income')" id="tab-income" class="tab-btn active">Revenue</button>
                <button onclick="switchTab('expense')" id="tab-expense" class="tab-btn">Expense</button>
            </div>
            <form id="transactionForm" class="space-y-4">
                <input type="hidden" id="entryType" value="income"><input type="hidden" id="editId" value="">
                <div><label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Date</label><input type="date" id="t-date" required></div>
                <div id="income-fields">
                    <div><label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Service Provided</label><input type="text" id="t-service" list="serviceList" placeholder="e.g. CV Design"><datalist id="serviceList"><option value="Assignment Work"><option value="CV Document Design"><option value="System Development"><option value="Letter Writing"></datalist></div>
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <div><label class="text-[10px] font-black text-emerald-600 uppercase ml-2 mb-1 block">Amount</label><input type="number" id="t-income" placeholder="0.00" step="0.01"></div>
                        <div><label class="text-[10px] font-black text-amber-500 uppercase ml-2 mb-1 block">To Savings</label><input type="number" id="t-savings" placeholder="0.00" step="0.01"></div>
                    </div>
                </div>
                <div id="expense-fields" class="hidden">
                    <div><label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Description</label><input type="text" id="t-reason" placeholder="What was this for?"></div>
                    <div class="mt-4"><label class="text-[10px] font-black text-rose-500 uppercase ml-2 mb-1 block">Amount (Rs.)</label><input type="number" id="t-expense" placeholder="0.00" step="0.01"></div>
                </div>
                <button type="submit" id="saveBtn" class="w-full py-5 bg-indigo-600 text-white rounded-[1.5rem] font-black uppercase text-xs shadow-lg mt-6 btn-touch">Confirm Transaction</button>
                <button type="button" onclick="closeForm()" class="w-full py-3 text-slate-400 font-bold uppercase text-[10px]">Back to Dashboard</button>
            </form>
        </div>
    </div>

    <div id="previewModal" class="modal-overlay hidden" onclick="closePreview()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div id="previewContent" class="space-y-6"></div>
            <div class="flex gap-3 mt-10">
                <button id="editBtn" class="flex-1 py-5 bg-slate-900 dark:bg-indigo-600 text-white rounded-2xl font-black uppercase text-xs btn-touch">Edit Record</button>
                <button id="delBtn" class="w-16 h-16 bg-rose-50 text-rose-500 rounded-2xl flex items-center justify-center btn-touch"><i class="fas fa-trash-can"></i></button>
            </div>
        </div>
    </div>

    <div id="summaryModal" class="modal-overlay hidden" onclick="closeSummary()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3 id="summaryTitle" class="text-xl font-black uppercase mb-6">Summary</h3>
            <div id="summaryList" class="space-y-3"></div>
        </div>
    </div>

    <div id="reportsModal" class="modal-overlay hidden" onclick="closeReports()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black uppercase mb-8 text-center">Generate Statements</h3>
            <div class="space-y-4">
                <div><label class="text-[10px] font-black text-slate-400 ml-2">Start Date</label><input type="date" id="rep-start"></div>
                <div><label class="text-[10px] font-black text-slate-400 ml-2">End Date</label><input type="date" id="rep-end"></div>
                <button onclick="generatePDF()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase text-xs mt-6 btn-touch"><i class="fas fa-file-pdf mr-2"></i>Download PDF Report</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXUjPo_M4Ov6k32fDtH62mcqkLpfOXzj4",
            authDomain: "smartdocs-finance.firebaseapp.com",
            projectId: "smartdocs-finance",
            storageBucket: "smartdocs-finance.firebasestorage.app",
            messagingSenderId: "409217197572",
            appId: "1:409217197572:web:41557e30567ff7fac23751",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let allRecords = [];

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) syncData();
            else signInAnonymously(auth);
        });

        // Theme Toggle Function with Persistence
        window.toggleTheme = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            document.documentElement.classList.toggle('dark-mode');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            
            // Setting එක save කරනවා
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };

        // Icon එක නිවැරදිව පෙන්වීමට Page load එකේදී check කිරීම
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.getElementById('theme-icon').className = 'fas fa-sun';
            }
        });

        function syncData() {
            const ref = collection(db, 'artifacts', 'smartdocs-finance-pro', 'users', currentUser.uid, 'finance_v3');
            onSnapshot(ref, (snap) => {
                allRecords = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.date) - new Date(a.date));
                updateUI();
            });
        }

        window.updateUI = () => {
            const monthVal = document.getElementById('monthFilter').value;
            const catVal = document.getElementById('categoryFilter').value;
            let filtered = allRecords;
            if(monthVal) filtered = filtered.filter(r => r.date.startsWith(monthVal));
            if(catVal !== "All") filtered = (catVal === "Expenses") ? filtered.filter(r => r.type === 'expense') : filtered.filter(r => r.service === catVal);

            let tInc = 0, tExp = 0, tSav = 0;
            allRecords.forEach(r => {
                if(r.type === 'income') { tInc += parseFloat(r.income || 0); tSav += parseFloat(r.savings || 0); }
                else tExp += parseFloat(r.expense || 0);
            });

            document.getElementById('summary-cash').innerText = `Rs. ${(tInc - tExp - tSav).toLocaleString(undefined, {minimumFractionDigits:2})}`;
            document.getElementById('total-income-view').innerText = `Rs. ${tInc.toLocaleString()}`;
            document.getElementById('total-expense-view').innerText = `Rs. ${tExp.toLocaleString()}`;
            document.getElementById('total-savings-view').innerText = `Rs. ${tSav.toLocaleString()}`;

            const list = document.getElementById('ledger-list');
            list.innerHTML = filtered.map(r => `
                <div onclick="showPreview('${r.id}')" class="bg-custom-card p-4 rounded-3xl flex items-center justify-between shadow-sm btn-touch border-slate-50 dark:border-slate-800/50">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center ${r.type === 'income' ? 'bg-emerald-500/10 text-emerald-600' : 'bg-rose-500/10 text-rose-500'}">
                            <i class="fas ${r.type === 'income' ? 'fa-arrow-trend-up' : 'fa-receipt'} text-sm"></i>
                        </div>
                        <div>
                            <p class="text-[11px] font-black uppercase truncate w-32">${r.type === 'income' ? (r.service || 'Service') : (r.reason || 'Expense')}</p>
                            <p class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter">${r.date}</p>
                        </div>
                    </div>
                    <p class="text-xs font-black ${r.type === 'income' ? 'text-emerald-600' : 'text-rose-500'}">${r.type === 'income' ? '+' : '-'} Rs. ${parseFloat(r.income || r.expense).toLocaleString()}</p>
                </div>
            `).join('');
        };

        window.showPreview = (id) => {
            const r = allRecords.find(x => x.id === id);
            const isInc = r.type === 'income';
            document.getElementById('previewContent').innerHTML = `
                <div class="p-6 rounded-3xl ${isInc ? 'bg-emerald-500/10 border-emerald-500/20' : 'bg-rose-500/10 border-rose-500/20'} border">
                    <p class="text-[10px] font-black uppercase text-slate-400 mb-1">Source</p>
                    <p class="text-xl font-black">${isInc ? r.service : r.reason}</p>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl text-center"><p class="text-[9px] font-black text-slate-400 uppercase">Date</p><p class="font-bold text-xs">${r.date}</p></div>
                    <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl text-center"><p class="text-[9px] font-black text-slate-400 uppercase">Category</p><p class="font-bold text-xs uppercase ${isInc ? 'text-emerald-500' : 'text-rose-500'}">${isInc ? 'Revenue' : 'Expense'}</p></div>
                </div>
                <div class="bg-indigo-600 p-6 rounded-3xl text-white shadow-xl relative overflow-hidden">
                    <p class="text-[10px] font-black text-indigo-200 uppercase mb-1">Total Amount</p>
                    <p class="text-3xl font-black italic">Rs. ${parseFloat(isInc ? r.income : r.expense).toLocaleString(undefined, {minimumFractionDigits:2})}</p>
                </div>
            `;
            document.getElementById('editBtn').onclick = () => { closePreview(); openEditForm(r); };
            document.getElementById('delBtn').onclick = () => deleteEntry(r.id);
            document.getElementById('previewModal').classList.remove('hidden');
        };

        window.openEditForm = (r) => {
            document.getElementById('editId').value = r.id;
            document.getElementById('t-date').value = r.date;
            switchTab(r.type);
            if(r.type === 'income') { document.getElementById('t-service').value = r.service; document.getElementById('t-income').value = r.income; document.getElementById('t-savings').value = r.savings; }
            else { document.getElementById('t-reason').value = r.reason; document.getElementById('t-expense').value = r.expense; }
            document.getElementById('saveBtn').innerText = "Update Record";
            document.getElementById('formModal').classList.remove('hidden');
        };

        window.deleteEntry = async (id) => {
            if(confirm("Delete this record?")) { await deleteDoc(doc(db, 'artifacts', 'smartdocs-finance-pro', 'users', currentUser.uid, 'finance_v3', id)); closePreview(); }
        };

        document.getElementById('transactionForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const type = document.getElementById('entryType').value;
            const payload = { type, date: document.getElementById('t-date').value, timestamp: Date.now() };
            if(type === 'income') { payload.service = document.getElementById('t-service').value; payload.income = parseFloat(document.getElementById('t-income').value); payload.savings = parseFloat(document.getElementById('t-savings').value); }
            else { payload.reason = document.getElementById('t-reason').value; payload.expense = parseFloat(document.getElementById('t-expense').value); }
            const ref = collection(db, 'artifacts', 'smartdocs-finance-pro', 'users', currentUser.uid, 'finance_v3');
            if(id) await updateDoc(doc(ref, id), payload); else await addDoc(ref, payload);
            closeForm();
        };

        window.switchTab = (type) => {
            document.getElementById('entryType').value = type;
            document.getElementById('tab-income').classList.toggle('active', type === 'income');
            document.getElementById('tab-expense').classList.toggle('active', type === 'expense');
            document.getElementById('income-fields').classList.toggle('hidden', type === 'expense');
            document.getElementById('expense-fields').classList.toggle('hidden', type === 'income');
        };

        window.generatePDF = () => {
            const start = document.getElementById('rep-start').value, end = document.getElementById('rep-end').value;
            if(!start || !end) return alert("Select date range");
            const filtered = allRecords.filter(r => r.date >= start && r.date <= end);
            const { jsPDF } = window.jspdf; const docPDF = new jsPDF();
            docPDF.setFillColor(30, 27, 75); docPDF.rect(0, 0, 210, 40, 'F');
            docPDF.setTextColor(255, 255, 255); docPDF.setFontSize(20); docPDF.text("SMARTDOCS SRI LANKA", 15, 22);
            let tI = 0, tE = 0;
            const body = filtered.map(r => {
                const inc = r.type === 'income' ? r.income : 0, exp = r.type === 'expense' ? r.expense : 0;
                tI += inc; tE += exp;
                return [r.date, r.type === 'income' ? r.service : r.reason, r.type.toUpperCase(), `Rs. ${inc.toLocaleString()}`, `Rs. ${exp.toLocaleString()}`];
            });
            docPDF.autoTable({ startY: 50, head: [['Date', 'Description', 'Type', 'Revenue', 'Expense']], body, foot: [['', 'TOTALS', '', `Rs. ${tI.toLocaleString()}`, `Rs. ${tE.toLocaleString()}`]], headStyles: { fillColor: [79, 70, 229] }, footStyles: { fillColor: [30, 27, 75], textColor: 255 } });
            docPDF.save(`SmartDocs_Report_${start}.pdf`);
        };

        window.openForm = () => { document.getElementById('editId').value = ""; document.getElementById('transactionForm').reset(); document.getElementById('t-date').value = new Date().toISOString().split('T')[0]; document.getElementById('formModal').classList.remove('hidden'); };
        window.closeForm = () => document.getElementById('formModal').classList.add('hidden');
        window.closePreview = () => document.getElementById('previewModal').classList.add('hidden');
        window.closeSummary = () => document.getElementById('summaryModal').classList.add('hidden');
        window.closeReports = () => document.getElementById('reportsModal').classList.add('hidden');
        window.openReports = () => document.getElementById('reportsModal').classList.remove('hidden');
        window.resetFilters = () => { document.getElementById('monthFilter').value = ""; document.getElementById('categoryFilter').value = "All"; updateUI(); };
        window.openSummary = (type) => {
            let filtered = (type === 'income') ? allRecords.filter(r => r.type === 'income') : (type === 'expense' ? allRecords.filter(r => r.type === 'expense') : allRecords.filter(r => r.type === 'income' && r.savings > 0));
            document.getElementById('summaryList').innerHTML = filtered.map(r => `<div class="p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl flex justify-between items-center"><div><p class="text-[11px] font-black">${r.type === 'income' ? r.service : r.reason}</p><p class="text-[8px] text-slate-400 font-bold uppercase">${r.date}</p></div><p class="font-black text-xs ${type==='expense'?'text-rose-500':'text-emerald-500'}">Rs. ${parseFloat(type==='savings'?r.savings:(r.income||r.expense)).toLocaleString()}</p></div>`).join('');
            document.getElementById('summaryModal').classList.remove('hidden');
        };
    </script>
</body>
</html>
